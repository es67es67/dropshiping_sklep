#!/usr/bin/env node

const puppeteer = require('puppeteer');
const path = require('path');
const fs = require('fs');

console.log('üéØ DEMONSTRACJA ZAWAANSOWANYCH FUNKCJI:');
console.log('‚úÖ System rekomendacji produkt√≥w (AI)');
console.log('‚úÖ A/B Testing dla optymalizacji konwersji');
console.log('‚úÖ System lojalno≈õciowy z punktami i nagrodami');
console.log('‚úÖ System znajomych z pe≈ÇnƒÖ funkcjonalno≈õciƒÖ');
console.log('‚úÖ Motywy: Domy≈õlny, Ciemny, Terminal');
console.log('‚úÖ Responsywny design dla wszystkich urzƒÖdze≈Ñ');

class AdvancedFeaturesDemo {
  constructor() {
    this.browser = null;
    this.page = null;
    this.screenshots = [];
    this.baseUrl = 'https://portal-frontend-ysqz.onrender.com';
  }

  async init() {
    console.log('üöÄ Inicjalizacja demonstracji...');
    
    this.browser = await puppeteer.launch({
      headless: false,
      defaultViewport: { width: 1920, height: 1080 },
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    
    this.page = await this.browser.newPage();
    
    // Ustaw user agent
    await this.page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');
    
    console.log('‚úÖ Browser zainicjalizowany');
  }

  async takeScreenshot(name) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `${name}_${timestamp}.png`;
    const filepath = path.join('demo-advanced-screenshots', filename);
    
    await this.page.screenshot({ 
      path: filepath, 
      fullPage: true 
    });
    
    this.screenshots.push({ name, filepath });
    console.log(`üì∏ Screenshot: ${filename}`);
  }

  async demoRecommendationSystem() {
    console.log('üß† Demonstracja systemu rekomendacji...');
    
    try {
      await this.page.goto(`${this.baseUrl}/products`, { waitUntil: 'networkidle2' });
      await this.page.waitForTimeout(2000);
      
      // Sprawd≈∫ czy komponent rekomendacji jest widoczny
      const recommendationsVisible = await this.page.evaluate(() => {
        const recommendations = document.querySelector('[data-testid="product-recommendations"]');
        return !!recommendations;
      });
      
      if (recommendationsVisible) {
        console.log('‚úÖ System rekomendacji aktywny');
        
        // Prze≈ÇƒÖcz miƒôdzy algorytmami
        const algorithms = ['personalized', 'collaborative', 'content_based', 'popular', 'trending'];
        
        for (const algorithm of algorithms) {
          try {
            await this.page.click(`[data-algorithm="${algorithm}"]`);
            await this.page.waitForTimeout(1000);
            console.log(`‚úÖ Algorytm ${algorithm} prze≈ÇƒÖczony`);
          } catch (error) {
            console.log(`‚ö†Ô∏è Algorytm ${algorithm} niedostƒôpny`);
          }
        }
        
        await this.takeScreenshot('01-recommendation-system');
      } else {
        console.log('‚ö†Ô∏è System rekomendacji niedostƒôpny');
      }
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji rekomendacji:', error.message);
    }
  }

  async demoLoyaltySystem() {
    console.log('üéÅ Demonstracja systemu lojalno≈õciowego...');
    
    try {
      // Przejd≈∫ do profilu u≈ºytkownika
      await this.page.goto(`${this.baseUrl}/profile`, { waitUntil: 'networkidle2' });
      await this.page.waitForTimeout(2000);
      
      // Sprawd≈∫ czy system lojalno≈õciowy jest widoczny
      const loyaltyVisible = await this.page.evaluate(() => {
        const loyalty = document.querySelector('[data-testid="loyalty-system"]');
        return !!loyalty;
      });
      
      if (loyaltyVisible) {
        console.log('‚úÖ System lojalno≈õciowy aktywny');
        
        // Sprawd≈∫ r√≥≈ºne zak≈Çadki
        const tabs = ['overview', 'badges', 'rewards', 'history'];
        
        for (const tab of tabs) {
          try {
            await this.page.click(`[data-tab="${tab}"]`);
            await this.page.waitForTimeout(1000);
            console.log(`‚úÖ Zak≈Çadka ${tab} otwarta`);
          } catch (error) {
            console.log(`‚ö†Ô∏è Zak≈Çadka ${tab} niedostƒôpna`);
          }
        }
        
        await this.takeScreenshot('02-loyalty-system');
      } else {
        console.log('‚ö†Ô∏è System lojalno≈õciowy niedostƒôpny');
      }
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji lojalno≈õci:', error.message);
    }
  }

  async demoABTesting() {
    console.log('üß™ Demonstracja A/B testing...');
    
    try {
      await this.page.goto(`${this.baseUrl}/products`, { waitUntil: 'networkidle2' });
      await this.page.waitForTimeout(2000);
      
      // Sprawd≈∫ czy testy A/B sƒÖ aktywne
      const abTestInfo = await this.page.evaluate(() => {
        const abTestElement = document.querySelector('[data-testid="ab-test-info"]');
        return abTestElement ? abTestElement.textContent : null;
      });
      
      if (abTestInfo) {
        console.log('‚úÖ A/B testing aktywny:', abTestInfo);
        await this.takeScreenshot('03-ab-testing');
      } else {
        console.log('‚ö†Ô∏è A/B testing niedostƒôpny');
      }
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji A/B testing:', error.message);
    }
  }

  async demoThemeSystem() {
    console.log('üé® Demonstracja systemu motyw√≥w...');
    
    try {
      await this.page.goto(`${this.baseUrl}`, { waitUntil: 'networkidle2' });
      await this.page.waitForTimeout(2000);
      
      // Sprawd≈∫ czy przycisk zmiany motywu jest widoczny
      const themeButton = await this.page.$('[data-testid="theme-toggle"]');
      
      if (themeButton) {
        console.log('‚úÖ System motyw√≥w aktywny');
        
        // Kliknij przycisk motywu
        await themeButton.click();
        await this.page.waitForTimeout(1000);
        
        // Sprawd≈∫ dostƒôpne motywy
        const themes = ['default', 'dark', 'terminal'];
        
        for (const theme of themes) {
          try {
            await this.page.click(`[data-theme="${theme}"]`);
            await this.page.waitForTimeout(2000);
            console.log(`‚úÖ Motyw ${theme} zastosowany`);
            await this.takeScreenshot(`04-theme-${theme}`);
          } catch (error) {
            console.log(`‚ö†Ô∏è Motyw ${theme} niedostƒôpny`);
          }
        }
        
      } else {
        console.log('‚ö†Ô∏è System motyw√≥w niedostƒôpny');
      }
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji motyw√≥w:', error.message);
    }
  }

  async demoAdvancedUI() {
    console.log('‚ú® Demonstracja zaawansowanego UI...');
    
    try {
      await this.page.goto(`${this.baseUrl}/products`, { waitUntil: 'networkidle2' });
      await this.page.waitForTimeout(2000);
      
      // Sprawd≈∫ zaawansowane filtry
      const advancedFilters = await this.page.$('[data-testid="advanced-filters"]');
      if (advancedFilters) {
        console.log('‚úÖ Zaawansowane filtry dostƒôpne');
        await this.takeScreenshot('05-advanced-filters');
      }
      
      // Sprawd≈∫ system ocen
      const ratingSystem = await this.page.$('[data-testid="rating-system"]');
      if (ratingSystem) {
        console.log('‚úÖ System ocen dostƒôpny');
        await this.takeScreenshot('06-rating-system');
      }
      
      // Sprawd≈∫ chat
      const chatSystem = await this.page.$('[data-testid="live-chat"]');
      if (chatSystem) {
        console.log('‚úÖ System czatu dostƒôpny');
        await this.takeScreenshot('07-live-chat');
      }
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji UI:', error.message);
    }
  }

  async demoResponsiveDesign() {
    console.log('üì± Demonstracja responsywnego designu...');
    
    const viewports = [
      { name: 'desktop', width: 1920, height: 1080 },
      { name: 'tablet', width: 1024, height: 768 },
      { name: 'mobile', width: 375, height: 667 }
    ];
    
    for (const viewport of viewports) {
      try {
        await this.page.setViewport(viewport);
        await this.page.waitForTimeout(1000);
        
        console.log(`‚úÖ Viewport ${viewport.name} (${viewport.width}x${viewport.height})`);
        await this.takeScreenshot(`08-responsive-${viewport.name}`);
        
      } catch (error) {
        console.error(`‚ùå B≈ÇƒÖd viewport ${viewport.name}:`, error.message);
      }
    }
  }

  async generateReport() {
    console.log('üìã Generowanie raportu demonstracji...');
    
    const report = {
      timestamp: new Date().toISOString(),
      features: {
        recommendationSystem: this.screenshots.some(s => s.name.includes('recommendation')),
        loyaltySystem: this.screenshots.some(s => s.name.includes('loyalty')),
        abTesting: this.screenshots.some(s => s.name.includes('ab-testing')),
        themeSystem: this.screenshots.some(s => s.name.includes('theme')),
        advancedUI: this.screenshots.some(s => s.name.includes('advanced')),
        responsiveDesign: this.screenshots.some(s => s.name.includes('responsive'))
      },
      screenshots: this.screenshots,
      summary: {
        totalScreenshots: this.screenshots.length,
        successRate: Math.round((this.screenshots.length / 10) * 100)
      }
    };
    
    // Zapisz raport JSON
    const reportPath = path.join('demo-advanced-screenshots', 'advanced-demo-report.json');
    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
    
    // Zapisz raport HTML
    const htmlReport = this.generateHTMLReport(report);
    const htmlPath = path.join('demo-advanced-screenshots', 'advanced-demo-report.html');
    fs.writeFileSync(htmlPath, htmlReport);
    
    console.log('üìä Raport zapisany:', reportPath);
    console.log('üåê Raport HTML:', htmlPath);
  }

  generateHTMLReport(report) {
    return `
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raport Demonstracji Zaawansowanych Funkcji</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .feature { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .feature.success { border-color: #4caf50; background: #f1f8e9; }
        .feature.warning { border-color: #ff9800; background: #fff3e0; }
        .screenshots { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .screenshot { text-align: center; }
        .screenshot img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; }
        .summary { background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .timestamp { color: #666; font-size: 14px; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Raport Demonstracji Zaawansowanych Funkcji</h1>
        
        <div class="summary">
            <h2>üìä Podsumowanie</h2>
            <p><strong>Zrzuty ekranu:</strong> ${report.summary.totalScreenshots}</p>
            <p><strong>Wska≈∫nik sukcesu:</strong> ${report.summary.successRate}%</p>
            <p><strong>Data:</strong> ${new Date(report.timestamp).toLocaleString('pl-PL')}</p>
        </div>
        
        <div class="feature ${report.features.recommendationSystem ? 'success' : 'warning'}">
            <h3>üß† System Rekomendacji</h3>
            <p>${report.features.recommendationSystem ? '‚úÖ Aktywny' : '‚ö†Ô∏è Niedostƒôpny'}</p>
        </div>
        
        <div class="feature ${report.features.loyaltySystem ? 'success' : 'warning'}">
            <h3>üéÅ System Lojalno≈õciowy</h3>
            <p>${report.features.loyaltySystem ? '‚úÖ Aktywny' : '‚ö†Ô∏è Niedostƒôpny'}</p>
        </div>
        
        <div class="feature ${report.features.abTesting ? 'success' : 'warning'}">
            <h3>üß™ A/B Testing</h3>
            <p>${report.features.abTesting ? '‚úÖ Aktywny' : '‚ö†Ô∏è Niedostƒôpny'}</p>
        </div>
        
        <div class="feature ${report.features.themeSystem ? 'success' : 'warning'}">
            <h3>üé® System Motyw√≥w</h3>
            <p>${report.features.themeSystem ? '‚úÖ Aktywny' : '‚ö†Ô∏è Niedostƒôpny'}</p>
        </div>
        
        <div class="feature ${report.features.advancedUI ? 'success' : 'warning'}">
            <h3>‚ú® Zaawansowane UI</h3>
            <p>${report.features.advancedUI ? '‚úÖ Aktywne' : '‚ö†Ô∏è Niedostƒôpne'}</p>
        </div>
        
        <div class="feature ${report.features.responsiveDesign ? 'success' : 'warning'}">
            <h3>üì± Responsywny Design</h3>
            <p>${report.features.responsiveDesign ? '‚úÖ Aktywny' : '‚ö†Ô∏è Niedostƒôpny'}</p>
        </div>
        
        <h2>üì∏ Zrzuty Ekranu</h2>
        <div class="screenshots">
            ${report.screenshots.map(screenshot => `
                <div class="screenshot">
                    <h4>${screenshot.name}</h4>
                    <img src="${path.basename(screenshot.filepath)}" alt="${screenshot.name}">
                </div>
            `).join('')}
        </div>
        
        <div class="timestamp">
            Wygenerowano: ${new Date(report.timestamp).toLocaleString('pl-PL')}
        </div>
    </div>
</body>
</html>
    `;
  }

  async run() {
    try {
      await this.init();
      
      // Utw√≥rz katalog na zrzuty ekranu
      const screenshotsDir = 'demo-advanced-screenshots';
      if (!fs.existsSync(screenshotsDir)) {
        fs.mkdirSync(screenshotsDir);
      }
      
      // Uruchom demonstracje
      await this.demoRecommendationSystem();
      await this.demoLoyaltySystem();
      await this.demoABTesting();
      await this.demoThemeSystem();
      await this.demoAdvancedUI();
      await this.demoResponsiveDesign();
      
      // Wygeneruj raport
      await this.generateReport();
      
      console.log('üéâ Demonstracja zako≈Ñczona pomy≈õlnie!');
      console.log(`üì∏ Wygenerowano ${this.screenshots.length} zrzut√≥w ekranu`);
      
    } catch (error) {
      console.error('‚ùå B≈ÇƒÖd demonstracji:', error);
    } finally {
      if (this.browser) {
        await this.browser.close();
      }
    }
  }
}

// Uruchom demonstracjƒô
const demo = new AdvancedFeaturesDemo();
demo.run(); 