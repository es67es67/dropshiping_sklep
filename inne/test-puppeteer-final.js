// Skrypt testowania Chrome z Puppeteer - FINALNA WERSJA
const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');

const frontendUrl = 'https://portal-frontend-ysqz.onrender.com';
const backendUrl = 'https://portal-backend-igf9.onrender.com';

// Upewnij siƒô, ≈ºe katalog screenshots istnieje
const screenshotsDir = 'D:/portal/puppeteer-final-test';
if (!fs.existsSync(screenshotsDir)) {
    fs.mkdirSync(screenshotsDir, { recursive: true });
}

async function testPortalFinal() {
    console.log('üöÄ Testowanie portalu - FINALNA WERSJA...');
    
    let browser;
    let page;
    
    try {
        // Uruchom Chrome
        browser = await puppeteer.launch({
            headless: false, // Poka≈º przeglƒÖdarkƒô
            args: ['--no-sandbox', '--disable-setuid-sandbox'],
            slowMo: 1000 // Spowolnij akcje dla lepszej widoczno≈õci
        });
        
        page = await browser.newPage();
        
        // Przechwytuj logi konsoli
        page.on('console', msg => {
            const level = msg.type();
            const text = msg.text();
            const timestamp = new Date().toISOString();
            
            console.log(`[${timestamp}] [${level.toUpperCase()}] ${text}`);
            
            // Zapisz do pliku
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${text}\n`;
            fs.appendFileSync('D:/portal/puppeteer-final-logs.txt', logEntry);
        });
        
        // Przechwytuj b≈Çƒôdy
        page.on('pageerror', error => {
            console.log(`‚ùå B≈ÇƒÖd strony: ${error.message}`);
            fs.appendFileSync('D:/portal/puppeteer-final-errors.txt', `${new Date().toISOString()}: ${error.message}\n`);
        });
        
        // Przechwytuj b≈Çƒôdy sieciowe
        page.on('response', response => {
            if (!response.ok()) {
                console.log(`‚ö†Ô∏è B≈ÇƒÖd HTTP ${response.status()}: ${response.url()}`);
            }
        });

        // ===== TEST 1: STRONA G≈Å√ìWNA =====
        console.log('\nüåê TEST 1: Strona g≈Ç√≥wna');
        await page.goto(frontendUrl, { waitUntil: 'networkidle2' });
        await page.waitForTimeout(3000);
        
        const mainScreenshotPath = `${screenshotsDir}/01_main_page_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: mainScreenshotPath, fullPage: true });
        console.log(`üì∏ Screenshot strony g≈Ç√≥wnej: ${mainScreenshotPath}`);

        // ===== TEST 2: REJESTRACJA =====
        console.log('\nüìù TEST 2: Rejestracja nowego u≈ºytkownika');
        await page.goto(`${frontendUrl}/register`);
        await page.waitForTimeout(2000);
        
        // Generuj unikalne dane testowe
        const timestamp = Date.now();
        const testFirstName = `TestUser${timestamp}`;
        const testLastName = `TestLastName${timestamp}`;
        const testEmail = `test${timestamp}@example.com`;
        const testPassword = 'Test123!';
        
        console.log(`üë§ Rejestrujƒô u≈ºytkownika: ${testFirstName} ${testLastName} (${testEmail})`);
        
        // Wype≈Çnij formularz rejestracji
        await page.type('input[name="firstName"]', testFirstName);
        await page.type('input[name="lastName"]', testLastName);
        await page.type('input[name="email"]', testEmail);
        await page.type('input[name="password"]', testPassword);
        await page.type('input[name="confirmPassword"]', testPassword);
        await page.type('input[name="phone"]', '+48 123 456 789');
        await page.type('input[name="city"]', 'Warszawa');
        
        // Zaznacz checkboxy
        await page.click('input[name="acceptTerms"]');
        await page.click('input[name="acceptNewsletter"]');
        
        const registerScreenshotPath = `${screenshotsDir}/02_register_form_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: registerScreenshotPath });
        console.log(`üì∏ Screenshot formularza rejestracji: ${registerScreenshotPath}`);
        
        // Kliknij przycisk rejestracji
        await page.click('button[type="submit"]');
        await page.waitForTimeout(5000);
        
        const afterRegisterScreenshotPath = `${screenshotsDir}/03_after_register_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: afterRegisterScreenshotPath });
        console.log(`üì∏ Screenshot po rejestracji: ${afterRegisterScreenshotPath}`);

        // ===== TEST 3: LOGOWANIE =====
        console.log('\nüîê TEST 3: Logowanie');
        await page.goto(`${frontendUrl}/login`);
        await page.waitForTimeout(2000);
        
        // Wype≈Çnij formularz logowania
        await page.type('input[name="emailOrUsername"]', testEmail);
        await page.type('input[name="password"]', testPassword);
        
        const loginScreenshotPath = `${screenshotsDir}/04_login_form_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: loginScreenshotPath });
        console.log(`üì∏ Screenshot formularza logowania: ${loginScreenshotPath}`);
        
        // Kliknij przycisk logowania
        await page.click('button[type="submit"]');
        await page.waitForTimeout(5000);
        
        const afterLoginScreenshotPath = `${screenshotsDir}/05_after_login_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: afterLoginScreenshotPath });
        console.log(`üì∏ Screenshot po logowaniu: ${afterLoginScreenshotPath}`);

        // ===== TEST 4: SPRAWDZENIE MENU U≈ªYTKOWNIKA =====
        console.log('\nüë§ TEST 4: Sprawdzenie menu u≈ºytkownika');
        await page.waitForTimeout(3000);
        
        // Sprawd≈∫ czy u≈ºytkownik jest zalogowany i menu jest widoczne
        const userMenuExists = await page.evaluate(() => {
            // Sprawd≈∫ r√≥≈ºne mo≈ºliwe selektory menu u≈ºytkownika
            const selectors = [
                '[style*="cursor: pointer"]', // UserInfo z cursor pointer
                'div[style*="background"]', // UserInfo z t≈Çem
                'div:has(> div:contains("üë§"))', // Kontener z avatar
                'div:has(> div:contains("Poziom"))', // Kontener z poziomem
                'div[style*="border-radius: 8px"]', // UserInfo z border-radius
            ];
            
            for (const selector of selectors) {
                try {
                    const element = document.querySelector(selector);
                    if (element) {
                        console.log(`Znaleziono menu u≈ºytkownika: ${selector}`);
                        return true;
                    }
                } catch (e) {
                    // Ignoruj b≈Çƒôdy selektor√≥w
                }
            }
            
            // Sprawd≈∫ wszystkie divy z tekstem u≈ºytkownika
            const allDivs = document.querySelectorAll('div');
            for (const div of allDivs) {
                const text = div.textContent || '';
                if (text.includes('üë§') && text.includes('Poziom')) {
                    console.log('Znaleziono menu u≈ºytkownika przez tekst');
                    return true;
                }
            }
            
            return false;
        });
        
        if (userMenuExists) {
            console.log('‚úÖ Menu u≈ºytkownika znalezione!');
            
            // Kliknij w menu u≈ºytkownika
            await page.click('[style*="cursor: pointer"]');
            await page.waitForTimeout(2000);
            
            const userMenuScreenshotPath = `${screenshotsDir}/06_user_menu_open_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            await page.screenshot({ path: userMenuScreenshotPath });
            console.log(`üì∏ Screenshot menu u≈ºytkownika: ${userMenuScreenshotPath}`);
            
            // Sprawd≈∫ czy "Moje sklepy" jest w menu
            const myShopsInMenu = await page.evaluate(() => {
                const menuText = document.body.textContent || '';
                return menuText.includes('Moje sklepy');
            });
            
            if (myShopsInMenu) {
                console.log('‚úÖ "Moje sklepy" znalezione w menu u≈ºytkownika!');
            } else {
                console.log('‚ö†Ô∏è "Moje sklepy" nie znalezione w menu u≈ºytkownika');
            }
        } else {
            console.log('‚ùå Menu u≈ºytkownika nie znalezione');
        }

        // ===== TEST 5: DODANIE SKLEPU =====
        console.log('\n‚ûï TEST 5: Dodanie nowego sklepu');
        await page.goto(`${frontendUrl}/shop-create`);
        await page.waitForTimeout(3000);
        
        // Wype≈Çnij formularz sklepu
        const shopName = `Test Shop ${timestamp}`;
        const shopDescription = 'To jest testowy sklep utworzony przez Puppeteer';
        
        await page.type('input[name="name"]', shopName);
        await page.type('textarea[name="description"]', shopDescription);
        await page.select('select[name="category"]', 'Elektronika');
        await page.type('input[name="address"]', 'Testowa ulica 123');
        await page.type('input[name="city"]', 'Warszawa');
        await page.type('input[name="postalCode"]', '00-001');
        await page.type('input[name="phone"]', '+48 123 456 789');
        await page.type('input[name="email"]', 'shop@test.com');
        await page.type('input[name="website"]', 'https://test-shop.pl');
        await page.type('input[name="openingHours"]', 'Pon-Pt 9:00-18:00, Sob 9:00-14:00');
        
        const shopFormScreenshotPath = `${screenshotsDir}/07_shop_form_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: shopFormScreenshotPath, fullPage: true });
        console.log(`üì∏ Screenshot formularza sklepu: ${shopFormScreenshotPath}`);
        
        // Kliknij przycisk dodania sklepu
        await page.click('button[type="submit"]');
        await page.waitForTimeout(5000);
        
        const afterShopCreateScreenshotPath = `${screenshotsDir}/08_after_shop_create_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: afterShopCreateScreenshotPath });
        console.log(`üì∏ Screenshot po dodaniu sklepu: ${afterShopCreateScreenshotPath}`);

        // ===== TEST 6: SPRAWDZENIE "ADD PRODUCT" (powinno byƒá widoczne po dodaniu sklepu) =====
        console.log('\nüì¶ TEST 6: Sprawdzenie widoczno≈õci "Add Product"');
        await page.goto(`${frontendUrl}/product-create`);
        await page.waitForTimeout(3000);
        
        // Sprawd≈∫ czy formularz produktu jest widoczny
        const productFormVisible = await page.evaluate(() => {
            const form = document.querySelector('form');
            const submitButton = document.querySelector('button[type="submit"]');
            return form && submitButton;
        });
        
        if (productFormVisible) {
            console.log('‚úÖ Formularz produktu jest widoczny (u≈ºytkownik ma sklepy)');
            
            // Wype≈Çnij formularz produktu
            const productName = `Test Product ${timestamp}`;
            const productDescription = 'To jest testowy produkt utworzony przez Puppeteer';
            
            await page.type('input[name="name"]', productName);
            await page.type('textarea[name="description"]', productDescription);
            await page.type('input[name="price"]', '99.99');
            await page.select('select[name="category"]', 'Elektronika');
            
            const productFormScreenshotPath = `${screenshotsDir}/09_product_form_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            await page.screenshot({ path: productFormScreenshotPath, fullPage: true });
            console.log(`üì∏ Screenshot formularza produktu: ${productFormScreenshotPath}`);
            
            // Kliknij przycisk dodania produktu
            await page.click('button[type="submit"]');
            await page.waitForTimeout(5000);
            
            const afterProductCreateScreenshotPath = `${screenshotsDir}/10_after_product_create_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            await page.screenshot({ path: afterProductCreateScreenshotPath });
            console.log(`üì∏ Screenshot po dodaniu produktu: ${afterProductCreateScreenshotPath}`);
        } else {
            console.log('‚ö†Ô∏è Formularz produktu nie jest widoczny (u≈ºytkownik nie ma sklep√≥w)');
        }

        // ===== TEST 7: USTAWIENIA WYGLƒÑDU =====
        console.log('\nüé® TEST 7: Ustawienia wyglƒÖdu');
        await page.goto(`${frontendUrl}/layout-customization`);
        await page.waitForTimeout(3000);
        
        // Sprawd≈∫ czy strona ustawie≈Ñ siƒô za≈Çadowa≈Ça
        const settingsLoaded = await page.evaluate(() => {
            return document.body.textContent.includes('Dostosuj wyglƒÖd') || 
                   document.body.textContent.includes('Layout') ||
                   document.body.textContent.includes('Theme');
        });
        
        if (settingsLoaded) {
            console.log('‚úÖ Strona ustawie≈Ñ wyglƒÖdu za≈Çadowana');
            
            // Zmie≈Ñ layout na compact
            await page.select('select[name="layout"]', 'compact');
            
            // Zmie≈Ñ theme na dark
            await page.select('select[name="theme"]', 'dark');
            
            // Zapisz ustawienia
            await page.click('button[type="submit"]');
            await page.waitForTimeout(3000);
            
            const settingsScreenshotPath = `${screenshotsDir}/11_settings_saved_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            await page.screenshot({ path: settingsScreenshotPath });
            console.log(`üì∏ Screenshot po zapisaniu ustawie≈Ñ: ${settingsScreenshotPath}`);
            
            // Sprawd≈∫ czy strona siƒô prze≈Çadowa≈Ça
            const currentUrl = page.url();
            if (currentUrl.includes('/layout-customization')) {
                console.log('‚úÖ Ustawienia zosta≈Çy zapisane i strona siƒô prze≈Çadowa≈Ça');
            } else {
                console.log('‚ö†Ô∏è Strona nie prze≈Çadowa≈Ça siƒô po zapisaniu ustawie≈Ñ');
            }
        } else {
            console.log('‚ùå Strona ustawie≈Ñ wyglƒÖdu nie za≈Çadowa≈Ça siƒô');
        }

        // ===== TEST 8: WYLOGOWANIE =====
        console.log('\nüö™ TEST 8: Wylogowanie');
        
        // Przejd≈∫ do strony g≈Ç√≥wnej
        await page.goto(frontendUrl);
        await page.waitForTimeout(3000);
        
        // Spr√≥buj znale≈∫ƒá i kliknƒÖƒá przycisk wylogowania
        try {
            // Kliknij w menu u≈ºytkownika
            await page.click('[style*="cursor: pointer"]');
            await page.waitForTimeout(1000);
            
            // Kliknij w "Wyloguj"
            await page.click('div:contains("üö™ Wyloguj"), div:contains("Wyloguj")');
            await page.waitForTimeout(3000);
            
            console.log('‚úÖ Wylogowanie przez menu u≈ºytkownika');
        } catch (e) {
            console.log('‚ö†Ô∏è Nie uda≈Ço siƒô wylogowaƒá przez menu, przechodzƒô do strony logowania');
            await page.goto(`${frontendUrl}/login`);
            await page.waitForTimeout(3000);
        }
        
        const logoutScreenshotPath = `${screenshotsDir}/12_after_logout_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: logoutScreenshotPath });
        console.log(`üì∏ Screenshot po wylogowaniu: ${logoutScreenshotPath}`);

        // ===== TEST 9: SPRAWDZENIE "ADD PRODUCT" DLA NIEZALOGOWANEGO =====
        console.log('\nüì¶ TEST 9: Sprawdzenie "Add Product" dla niezalogowanego u≈ºytkownika');
        await page.goto(`${frontendUrl}/product-create`);
        await page.waitForTimeout(3000);
        
        // Sprawd≈∫ czy jest przekierowanie do logowania
        const currentUrl = page.url();
        if (currentUrl.includes('/login')) {
            console.log('‚úÖ Niezalogowany u≈ºytkownik zosta≈Ç przekierowany do logowania');
        } else {
            console.log('‚ö†Ô∏è Niezalogowany u≈ºytkownik ma dostƒôp do formularza produktu');
        }
        
        const unauthorizedScreenshotPath = `${screenshotsDir}/13_unauthorized_access_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        await page.screenshot({ path: unauthorizedScreenshotPath });
        console.log(`üì∏ Screenshot dostƒôpu bez autoryzacji: ${unauthorizedScreenshotPath}`);

        console.log('\n‚úÖ Wszystkie testy zako≈Ñczone pomy≈õlnie!');
        console.log(`üìÅ Screenshoty zapisane w: ${screenshotsDir}`);
        console.log(`üìÑ Logi zapisane w: D:/portal/puppeteer-final-logs.txt`);
        console.log(`‚ùå B≈Çƒôdy zapisane w: D:/portal/puppeteer-final-errors.txt`);
        
    } catch (error) {
        console.error('‚ùå B≈ÇƒÖd podczas testowania:', error);
        
        // Zr√≥b screenshot b≈Çƒôdu
        if (page) {
            const errorScreenshotPath = `${screenshotsDir}/ERROR_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            await page.screenshot({ path: errorScreenshotPath });
            console.log(`üì∏ Screenshot b≈Çƒôdu: ${errorScreenshotPath}`);
        }
    } finally {
        if (browser) {
            await browser.close();
            console.log('üîå PrzeglƒÖdarka zamkniƒôta');
        }
    }
}

// Uruchom testowanie
testPortalFinal(); 